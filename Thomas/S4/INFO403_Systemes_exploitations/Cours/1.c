#include<unistd.h>
#include<stdlib.h>
#include<stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <time.h>
int main(int argc, char * argv[])
{
	int n = atoi(argv[1]);
	int *T = (int * )malloc(n*2*sizeof(int));
	int buf=1;
	//Creation des tubes
	for(int i = 0; i < n ; i++ )
	{
		pipe(&T[2*i]);	
	}
	for(int i=0;i<n;i++)
	{
		//Création des N processus fils
		if (fork()==0)
		{
			// On nomme spécifiquement ce que l'on utilisera
			int in = T[ ( (2*(i-1) ) % (2*n) )];
			int out = T[((2*i)+1)%(2*n)];
			// cas spécifique, le modulo ne se fait pas avec une valeur négative
			if (i==0){in = T[ ( (2*(i-1) ) + (2*n) )];}

			//Fermeture des autres tubes
			for (int k=0;k<2*n;k++)
			{
				if ((T[k]!=in)&&(T[k]!=out)){
					close(T[k]);	
				}
			}
			
			//Premier Processus fils, J'écris puis je lis		
			if(i==0)
			{
				write(out,&buf,sizeof(int));
				printf("pid :%d envoie %d\n",getpid(),buf);
				read(in,&buf,sizeof(int));	
				printf("pid :%d recoit %d\n",getpid(),buf);
			}
			else //autres processus fils, Je lis puis j'écris
			{
				read(in,&buf,sizeof(int));
				sleep(1);
				printf("pid :%d recoit %d\n",getpid(),buf);
				buf ++;
				sleep(1);
				printf("pid :%d envoie %d\n",getpid(),buf);
				write(out,&buf,sizeof(int));				
			}
			
			// Fermeture, terminaison
			close(in);
			close(out);
			exit(0);	
		}	
	}
	
	//attente de la fin de tous les processus fils
	for(int i=0;i<n;i++)
	{
		wait(NULL);
	}
    free(T);
	exit(0);
}